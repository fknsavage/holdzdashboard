<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Holdz N Chill – Join Load Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f1220;color:#fff;margin:0;padding:16px}
    .card{background:#171a2b;border:1px solid #ffc10755;border-radius:12px;padding:12px 14px;box-shadow:0 6px 28px #0006}
    label{display:block;margin-top:10px;font-size:14px;opacity:.95}
    input,button{width:100%;box-sizing:border-box;margin-top:6px;padding:10px 12px;border-radius:10px;border:1px solid #3a3d5c;background:#0f1120;color:#fff}
    button{background:#ffc107;color:#000;border:none;font-weight:700}
    pre{white-space:pre-wrap;background:#0f1120;border:1px solid #2b2f4b;padding:10px;border-radius:10px;max-height:45vh;overflow:auto}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:680px){.row{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <h2>Holdz N Chill – Browser Load Test</h2>
  <div class="card">
    <div class="row">
      <div>
        <label>API Base URL</label>
        <input id="api" value="https://holdznchill.onrender.com">
        <label>Parallel Joins</label>
        <input id="joins" type="number" value="40" min="1" max="300">
        <label>Cards per Join</label>
        <input id="cardsEach" type="number" value="1" min="1" max="5">
        <label>Name Prefix</label>
        <input id="prefix" value="MobileTester">
        <button id="runBtn">Run Test</button>
      </div>
      <div>
        <label>Status</label>
        <pre id="status">Idle</pre>
        <label>Summary</label>
        <pre id="summary"></pre>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    function uid(){ return 'user_' + Date.now() + Math.random().toString(36).slice(2,8); }
    function now(){ return (performance && performance.now) ? performance.now() : Date.now(); }

    async function fetchJSON(url, opts){
      const r = await fetch(url, opts);
      const j = await r.json().catch(()=> ({}));
      return { ok: r.ok, status: r.status, json: j };
    }

    function append(el, msg){
      el.textContent += (el.textContent ? '\n' : '') + msg;
      el.scrollTop = el.scrollHeight;
    }

    $('runBtn').addEventListener('click', async () => {
      const API = $('api').value.trim();
      const N = parseInt($('joins').value, 10) || 20;
      const CARDS = parseInt($('cardsEach').value, 10) || 1;
      const PREFIX = $('prefix').value.trim() || 'Tester';
      const statusEl = $('status');
      const summaryEl = $('summary');
      statusEl.textContent = 'Checking active game…';
      summaryEl.textContent = '';

      // Active game check
      const g = await fetchJSON(`${API}/active-game`);
      if (!g.ok) {
        statusEl.textContent = `No active game (HTTP ${g.status}). Create a game first.`;
        return;
      }
      const game = g.json;
      append(statusEl, `Active game: ${game.game_id} (cards total: ${game.card_count})`);
      append(statusEl, `Launching ${N} parallel join(s)…`);

      const t0 = Date.now();
      const tasks = Array.from({length: N}).map(async (_, i) => {
        const psid = uid();
        const name = `${PREFIX}_${i+1}`;
        const r0 = now();
        const r = await fetchJSON(`${API}/join-game`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ psid, name, cards_count: CARDS })
        });
        const r1 = now();
        if (r.ok) append(statusEl, `✔️ ${name} joined in ${Math.round(r1-r0)} ms (${(r.json.cards||[]).length} card(s))`);
        else append(statusEl, `❌ ${name} failed: ${r.json.message || 'HTTP '+r.status}`);
        return {
          ok: r.ok,
          ms: r1 - r0,
          cards: r.json.cards || [],
          msg: r.json.message || ''
        };
      });

      const results = await Promise.all(tasks);
      const t1 = Date.now();

      const successes = results.filter(x => x.ok);
      const failures = results.filter(x => !x.ok);
      const urls = successes.flatMap(s => s.cards);
      const seen = new Map();
      urls.forEach(u => seen.set(u, (seen.get(u)||0)+1));
      const dups = [...seen.entries()].filter(([,c]) => c>1);

      const times = successes.map(s => s.ms).sort((a,b)=>a-b);
      const avg = times.length ? Math.round(times.reduce((a,b)=>a+b,0)/times.length) : 0;
      const p95 = times.length ? Math.round(times[Math.floor(times.length*0.95)-1] || times[times.length-1]) : 0;

      summaryEl.textContent = [
        `Total joins: ${N}`,
        `Successes: ${successes.length}`,
        `Failures: ${failures.length}`,
        `Duplicates: ${dups.length ? JSON.stringify(dups) : 'None'}`,
        `Latency avg(ms): ${avg}, p95(ms): ${p95}`,
        `Elapsed(ms): ${t1 - t0}`
      ].join('\n');
    });
  </script>
</body>
</html>
